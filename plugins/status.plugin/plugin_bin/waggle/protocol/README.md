# Protocol Submodule

This package provides functionality for packing and unpacking the various
protocols used by the Waggle platform.

## Core Protocol Data Types

The Waggle platform implements a variety of data types, each used for a specific
layer of the message pipeline. The typical data flow looks like:

1. Plugin publishes **sensorgrams**.
2. Node bundles **sensorgrams** and plugin info into **datagram**.
3. Node bundles **datagrams** with sender and receiver info into **waggle message**.

The resulting waggle message, depicted visually, would be organized like:

```
+-------------------------+
| waggle message          |
| sender-info: node123    |
| receiver-info: beehive  |
| datagrams:              |
| +---------------------+ |
| | datagram 1          | |
| | plugin-info: sysmon | |
| | sensorgrams:        | |
| | +---------------+   | |
| | | measurement 1 |   | |
| | | measurement 2 |   | |
| | | ...           |   | |
| | | measurement n |   | |
| | +---------------+   | |
| +---------------------+ |
| ...more datagrams...    |
+-------------------------+
```

### Sensorgram

Sensorgrams capture information about a measurement. Specifically, they provide
support for:

* Timestamp
* Sensor ID
* Sensor Instance
* Parameter ID
* Value
* Value Type

### Datagram

### Waggle Message

## Core Protocol API

### waggle.protocol

#### pack_sensorgram(sensorgram)

Pack a dictionary into a sensorgram. The supported fields are:

* `sensor_id` **required** Sensor ID.
* `parameter_id` **required** Parameter ID.
* `value` **required** Measurement value.
* `timestamp` **optional** Seconds since epoch. Default is current time.
* `sensor_instance` **optional** Sensor instance. Default is 0.
* `type` **optional** Value type. Derived from value's Python type if not specified.

Supported types are:

* bytes
* str
* bool
* none type
* int signed / unsigned
* float32
* list of int
* list of float32

#### unpack_sensorgram(data)

Unpacks a sensorgram into a dictionary.

#### pack_sensorgrams(list_of_sensorgrams)

Packs a list of sensorgrams into a stream of sensorgram bytes.

#### unpack_sensorgrams(data)

Unpacks a stream of sensorgram bytes into a list of dictionaries.

#### pack_datagram(datagram)

Packs a dictionary into a datagram. The supported fields are:

* `plugin_id` **required** Plugin ID.
* `plugin_major_version` **required** Plugin major version.
* `plugin_minor_version` **optional** Plugin minor version. Default is 0.
* `plugin_patch_version` **optional** Plugin patch version. Default is 0.
* `plugin_instance` **optional** Plugin instance. Default is 0.
* `plugin_run_id` **optional** Plugin unique run ID. Automatically generated by module.
* `packet_type` **optional** Packet type. Default is 0.
* `packet_seq` **optional** Packet sequence number. Automatically incremented by module.
* `timestamp` **optional** Seconds since epoch. Default is current time.
* `body` **required** Payload bytes of body.

#### unpack_datagram(data)

Unpacks a datagram into a dictionary.

#### pack_message(message)

Packs a dictionary into a waggle message. The support fields are:

* `sender_id` **optional** Sender ID. Must be 16 character hex string. Default is '0000000000000000'.
* `sender_sub_id` **optional** Sender subsystem ID. Must be 16 character hex string. Default is '0000000000000000'.
* `receiver_id` **optional** Receiver ID. Must be 16 character hex string. Default is '0000000000000000'.
* `receiver_sub_id` **optional** Receiver subsystem ID. Must be 16 character hex string. Default is '0000000000000000'.
* `message_priority` **optional** Message processing priority. Default is 0.
* `message_major_type` **optional** Message major type. Default is 0.
* `message_minor_type` **optional** Message minor type. Default is 0.
* `protocol_major_version` **optional** Protocol major version. Default is 0.
* `protocol_minor_version` **optional** Protocol minor version. Default is 0.
* `protocol_patch_version` **optional** Protocol patch version. Default is 0.
* `sender_seq` **optional** Sender packet sequence number. Automatically incremented by module.
* `sender_sid` **optional** Sender session ID. Default is 0.
* `response_seq` **optional** Response packet sequence number. Default is 0.
* `response_sid` **optional** Response session ID. Default is 0.
* `token` **optional** Authentication token. Default '00000000'.
* `timestamp` **optional** Seconds since epoch. Default is current time.
* `body` **required** Payload bytes of body.

#### unpack_message(data)

Unpacks a waggle message into a dictionary.

## Basic Example

### Packing and Unpacking Sensorgrams

In our simplest example, we'll test packing and then unpacking some made up
sensorgrams.

```python
import waggle.protocol

sensorgrams = [
    {'sensor_id': 1, 'parameter_id': 0, 'value': 10},
    {'sensor_id': 2, 'parameter_id': 0, 'value': 22.1},
    {'sensor_id': 3, 'parameter_id': 0, 'value': b'blob of bytes'},
    {'sensor_id': 3, 'parameter_id': 1, 'value': 'string'},
    {'sensor_id': 4, 'parameter_id': 0, 'value': True, 'sensor_instance': 0},
    {'sensor_id': 4, 'parameter_id': 1, 'value': False, 'sensor_instance': 0},
    {'sensor_id': 4, 'parameter_id': 2, 'value': None, 'sensor_instance': 1},
]

# First, we'll pack some data of many different types.
packed_sensorgrams = waggle.protocol.pack_sensorgrams(sensorgrams)

# Now, we'll unpack and print all of that data.
print(waggle.protocol.unpack_sensorgrams(packed_sensorgrams))
```

### Packing and Unpacking Datagrams

```python
import waggle.protocol

# We'll do a more involved example, where we pack and unpack a datagram with
# a body of sensorgrams.

body = waggle.protocol.pack_sensorgrams([
    {'sensor_id': 1, 'parameter_id': 0, 'value': b'first'},
    {'sensor_id': 2, 'parameter_id': 0, 'value': b'second'},
    {'sensor_id': 3, 'parameter_id': 0, 'value': b'third'},
])

data = waggle.protocol.pack_datagram({
    'timestamp': 1234567,
    'plugin_id': 2,
    'plugin_major_version': 3,
    'plugin_minor_version': 5,
    'plugin_patch_version': 7,
    'plugin_instance': 11,
    'body': body,
})

print('--- datagram bytes')
print(data)

# Now, we'll unpack all of this.
datagram = waggle.protocol.unpack_datagram(data)
sensorgrams = waggle.protocol.unpack_sensorgrams(datagram['body'])

print('--- datagram')
print(datagram)

print('--- sensorgrams')
print(sensorgrams)
```
